<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
    <title>Áâ°Ë†£„Çµ„Éº„É¢„É≥„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É†</title>
    <link href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #f0f0f0;
            font-family: "Noto Sans JP", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
        }

        #main {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #main .main_wrap {
            width: 100%;
            max-width: 480px;
            height: auto;
            margin: auto;
            position: relative;
            perspective: 1000px;
            overflow: hidden;
            background: url("images/start.png") no-repeat center center;
            background-size: 100% auto;
            aspect-ratio: 3 / 4;
        }

        canvas {
            display: block;
            margin: auto;
            position: relative;
            z-index: 1;
            height: 100%;
            width: auto;
            aspect-ratio: 3 / 4;
        }

        #bgLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /*background-image: url("images/default_bg.png");*/
            background-size: cover;
            background-position: center;
            transition: transform 0.6s ease;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        #startScreen,
        #gameOverScreen,
        #clearScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: url("images/start.png") no-repeat center center;
            color: white;
            z-index: 10;
            padding: 10% 15%;
            box-sizing: border-box;
            color: rgb(52, 52, 52);
            background-size: 100% 100%;
        }

        #startScreen {
            background-image: url("images/start.png");
        }

        #gameOverScreen {
            background-image: url("images/gameover.png");
        }

        #clearScreen {
            background-image: url("images/clear.png");
        }

        #hearts {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 2;
        }

        #hearts img {
            width: 30px;
            height: 30px;
        }

        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            z-index: 3;
            text-shadow:
                1px 1px 0 #FFF,
                -1px 1px 0 #FFF,
                -1px -1px 0 #FFF,
                1px -1px 0 #FFF;
        }

        #difficultyDisplay {
            position: absolute;
            top: 10px;
            left: 150px;
            font-size: 24px;
            z-index: 3;
            text-shadow:
                1px 1px 0 #FFF,
                -1px 1px 0 #FFF,
                -1px -1px 0 #FFF,
                1px -1px 0 #FFF;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .ctrl-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #leftRight {
            display: flex;
            gap: 20px;
        }

        #finalScore,
        #finalClearScore {
            margin: 0 auto;
        }

        .btn {
            display: block;
            width: 100%;
            background: #0054ed;
            color: #FFF;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 3em;
            font-size: 20px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            transition: opacity 0.3s ease;
            user-select: none;
        }

        .x_share {
            display: flex;
            position: relative;
            margin-bottom: 0.5em;
            align-items: center;
        }

        .btn-sns {
            position: relative;
            width: 10px;
            height: 10px;
            padding: 1rem;
            display: inline-block;
            cursor: pointer;
        }

        .svg-icon {
            display: grid;
            place-content: center;
            position: absolute;
            inset: 0;
            margin: auto;
            transition: transform 0.5s ease;
            backface-visibility: hidden;
        }

        .svg-icon svg {
            width: 20px;
            height: 20px;
        }

        .svg-left {
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
            background-color: #000;
            border-radius: 50%;
        }

        .svg-right {
            clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);
            background-color: #000;
            border-radius: 50%;
        }


        .svg-icon svg {
            fill: #fff;
        }

        .svg-icon:last-child svg {
            transform: scale(0);
            transition: transform 1s;
        }


        /* „Éõ„Éê„ÉºÊôÇ„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË®≠ÂÆö */
        .btn-sns:hover .svg-left {
            transform: translateX(-20%) rotateY(-90deg);
        }

        .btn-sns:hover .svg-right {
            transform: translateX(20%) rotateY(90deg);
        }

        .btn-sns:hover .svg-icon:last-child svg {
            transform: scale(1.2);
            fill: #1da1f1;
        }

        .btn:hover {
            opacity: .7;
        }

        h1 {
            color: #0054ed;
        }

        #main_wrap *:not(.btn, .btn-sns) {
            user-select: none;
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 80%;
        }

        .modal .btn {
            margin: 10px auto;
            width: 80%;
        }

        @media (max-height: 639px) {
            #main .main_wrap {
                height: 100%;
                width: auto;
                min-height: 350px;
            }

            h1 {
                font-size: 3.5vh;
            }

            h2 {
                font-size: 3.2vh;
            }

            h1+p,
            h2+p,
            .btn,
            #score,
            #difficultyDisplay,
            .x_share {
                font-size: 3vh;
            }

            p.img {
                text-align: center;
            }

            p.img img {
                width: 80%;
            }

            .modal {
                padding: 2.8vh;
            }

            #hearts img {
                width: 3.5vh;
                height: 3.5vh;
            }

            #difficultyDisplay {
                left: 40%;
            }
        }

        @media (max-width: 479px) {
            #main .main_wrap {
                margin: 0 auto auto;
                max-height: none;
                height: auto;
                aspect-ratio: 3 / 4;
            }

            canvas {
                width: 100%;
                height: auto;
            }

            #startScreen img,
            #gameOverScreen img,
            #clearScreen img {
                width: 70%;
                display: block;
                margin: 0 auto;
            }

            h1 {
                font-size: 7vw;
            }

            h2 {
                font-size: 5vw;
            }

            h1+p,
            h2+p,
            .btn,
            #score,
            #difficultyDisplay,
            .x_share {
                font-size: 3.5vw;
            }
        }
    </style>
</head>

<body>
    <div id="main">
        <div class="main_wrap" id="main_wrap">
            <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
            <div id="startScreen">
                <h1>Áâ°Ë†£„Çµ„Éº„É¢„É≥„Ç≠„É£„ÉÉ„ÉÅ</h1>
                <p>„Åø„Åè„Å°„ÇÉ„Çì„ÅÆÂ•Ω„Åç„Å™Áâ°Ë†£„ÇÑ„Çµ„Éº„É¢„É≥ÂØøÂè∏„Çí„Åü„Åè„Åï„ÇìÈõÜ„ÇÅ„Å¶„Åø„Åè„Å°„ÇÉ„Çì„Å´‰ºö„ÅÑ„Å´Ë°å„Åì„ÅÜÔºÅ</p>
                <p class="img"><img src="images/start_img.png" alt=""></p>
                <a id="startBtn" class="btn"><span id="startBtnText">ÈÅä„Å∂</span></a>
            </div>
            <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
            <div id="gameOverScreen" style="display:none;">
                <h1 id="endTitle">„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
                <p class="img"><img src="images/gameover_img.png" alt=""></p>
                <p id="finalScore"></p>
                <div class="x_share">X„ÅßÁµêÊûú„Çí„Ç∑„Çß„Ç¢„Åó„Çà„ÅÜÔºÅ‚Üí„ÄÄ
                    <a class="btn-sns" id="shareBtn">
                        <div class="svg-icon svg-left">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon svg-right">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                                </path>
                            </svg>
                        </div>
                    </a>
                </div>
                <a class="btn" id="retryBtn">„É™„Éà„É©„Ç§</a>
                <a class="btn" id="backToStartBtn">„Çπ„Çø„Éº„Éà„Å´Êàª„Çã</a>
            </div>
            <!-- „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÁîªÈù¢ -->
            <div id="clearScreen" style="display:none;">
                <h1 id="clearTitle">„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ</h1>
                <p class="img"><img src="images/clear_img.png" alt=""></p>
                <p id="finalClearScore"></p>
                <div class="x_share">X„ÅßÁµêÊûú„Çí„Ç∑„Çß„Ç¢„Åó„Çà„ÅÜÔºÅ‚Üí„ÄÄ<a class="btn-sns" id="shareBtn_top">
                        <div class="svg-icon svg-left">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon svg-right">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                                </path>
                            </svg>
                        </div>
                    </a></div>
                <a class="btn" id="retryBtn_agein">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</a>
                <a class="btn" id="backToStartBtn_top">„Çπ„Çø„Éº„Éà„Å´Êàª„Çã</a>
            </div>

            <!-- Èõ£ÊòìÂ∫¶ÈÅ∏Êäû„Ç¶„Ç£„É≥„Éâ„Ç¶ -->
            <div id="difficultyModal" style="display:none;" class="modal">
                <h2>Èõ£ÊòìÂ∫¶„ÇíÈÅ∏„Çì„Åß„Å≠</h2>
                <p>‚òÖÈñãÁô∫Âêë„ÅëÔºöÊôÇÊúü„Å´Âêà„Çè„Åõ„Å¶„Éú„Çø„É≥„ÇíÂÖ¨Èñã</p>
                <a class="btn diffBtn" data-level="1">Á¨¨‰∏ÄÂºæÔºàÈõ£„Åó„ÅÑÔºâ</a>
                <a class="btn diffBtn" data-level="2">Á¨¨‰∫åÂºæÔºà„Åµ„Å§„ÅÜÔºâ</a>
                <a class="btn diffBtn" data-level="3">Á¨¨‰∏âÂºæÔºàÁ∞°ÂçòÔºâ</a>
            </div>

            <div id="bgLayer"></div>
            <canvas id="gameCanvas" width="480" height="640"></canvas>
            <div id="hearts"></div>
            <div id="difficultyDisplay">Level: 1</div>
            <div id="score">Score: 0</div>
        </div>
    </div>

    <!-- „Çπ„Éû„ÉõÁî®„Ç≥„É≥„Éà„É≠„Éº„É©„Éº -->
    <div id="controls" style="display:none;">
        <div id="leftRight">
            <a class="ctrl-btn" id="leftBtn">‚Üê</a>
            <a class="ctrl-btn" id="rightBtn">‚Üí</a>
        </div>
        <a class="ctrl-btn" id="jumpBtn">‚§¥</a>
    </div>

    <script>
        // ========= ÁîªÂÉè =========
        const IMG_PATHS = {
            player: "images/player.png",
            candy: "images/candy.png",
            donut: "images/donut.png",
            bomb: "images/bomb.png",
            heart: "images/heart.png",
            heartEmpty: "images/heart_empty.png",
            star: "images/star.png"
        };

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // ========= Èü≥Ê•Ω =========
        const sounds = {
            jump: new Audio("sounds/jump.mp3"),
            damage: new Audio("sounds/damage.mp3"),
            item: new Audio("sounds/item.mp3"),
            heart: new Audio("sounds/heart.mp3"),
            gameover: new Audio("sounds/gameover.mp3"), // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁî®
            clear: new Audio("sounds/clear.mp3"),       // „ÇØ„É™„Ç¢Áî®
            bgm: new Audio("sounds/bgm.mp3"),
            bgm_easy: new Audio("sounds/bgm.mp3"),
            bgm_normal: new Audio("sounds/bgm.mp3"),
            bgm_hard: new Audio("sounds/bgm.mp3"),
            star: new Audio("sounds/star.mp3")
        };

        // Èü≥„ÇíÈáç„Å≠„Å¶È≥¥„Çâ„Åô„Åü„ÇÅ„Å´ÊØéÂõû clone „Åó„Å¶ÂÜçÁîü
        function playSound(audio) {
            const s = audio.cloneNode();
            s.volume = 0.4; // Èü≥ÈáèË™øÊï¥
            s.play();
        }

        // „É´„Éº„ÉóÂÜçÁîüË®≠ÂÆö
        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.1; // Èü≥ÈáèË™øÊï¥Ôºà0.0„Äú1.0Ôºâ

        // ========= ËÉåÊôØÁÆ°ÁêÜ =========
        let bgImages = [
            "images/bg01.png",
            "images/bg02.png",
            "images/bg03.png",
            "images/bg04.png",
            "images/bg05.png"
        ]; // „É©„É≥„ÉÄ„É†„Å´‰Ωø„ÅÜËÉåÊôØÁîªÂÉè

        const bgLayer = document.getElementById("bgLayer");
        let shuffledImages = [];
        let firstBgUsed = false;

        // „Ç∑„É£„ÉÉ„Éï„É´Èñ¢Êï∞ÔºàFisher‚ÄìYatesÔºâ
        function shuffleArray(array) {
            let arr = array.slice();
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function setBackgroundShuffledWithFlip() {
            let img;
            const setting = difficultySettings[currentDifficulty];

            if (!firstBgUsed) {
                // ‚òÖ ÊúÄÂàù„Å†„ÅëÈõ£ÊòìÂ∫¶„Åî„Å®„ÅÆÂõ∫ÂÆöËÉåÊôØ„Çí‰ΩøÁî®
                img = setting.bgFirst;
                firstBgUsed = true;
            } else {
                // ÁîªÂÉè„ÅåÂ∞Ω„Åç„Åü„ÇâÂÜç„Ç∑„É£„ÉÉ„Éï„É´
                if (shuffledImages.length === 0) {
                    // ÈÄ£Á∂ö„ÅßÂêå„ÅòÁîªÂÉè„ÅåÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´ÂÜç„Ç∑„É£„ÉÉ„Éï„É´
                    do {
                        shuffledImages = shuffleArray(bgImages);
                    } while (shuffledImages[0] === lastUsedImage);
                }

                // Ê¨°„ÅÆÁîªÂÉè„ÇíÂèñ„ÇäÂá∫„Åó
                img = shuffledImages.shift();
            }

            // ‰ªäÂõû‰Ωø„Å£„ÅüÁîªÂÉè„ÇíË®òÊÜ∂
            lastUsedImage = img;

            // 0 ‚Üí 180Â∫¶ ÂõûËª¢ÔºàË£èÂÅ¥„Å∏Ôºâ
            bgLayer.style.transform = "rotateY(180deg)";

            setTimeout(() => {
                // ÁîªÂÉè„ÇíÂàá„ÇäÊõø„Åà
                bgLayer.style.backgroundImage = `url(${img})`;

                // 360Â∫¶„Åæ„ÅßÂõûËª¢„Åó„Å¶Ê≠£Èù¢„Å´Êàª„Åô
                bgLayer.style.transform = "rotateY(360deg)";
            }, 300);
        }
        function resetBackgroundWithFlip() {
            // 0 ‚Üí 180Â∫¶ ÂõûËª¢
            bgLayer.style.transform = "rotateY(180deg)";

            setTimeout(() => {
                // Ë£èÂÅ¥„Åß„Éá„Éï„Ç©„É´„ÉàÁîªÂÉè„Å´Âàá„ÇäÊõø„Åà
                bgLayer.style.backgroundImage = `url(${defaultBgPath})`

                // 360Â∫¶„Å´Êàª„Åô
                bgLayer.style.transform = "rotateY(360deg)";
            }, 300);
        }

        // ========= „Ç∞„É≠„Éº„Éê„É´ =========
        let player, items, score, lives, gameInterval, dropInterval, speedMultiplier, gameRunning = false;
        let eventTimer, eventPhase = 0, katakanaIndex = 0;
        const gravity = 1;
        const difficultyDisplay = document.getElementById("difficultyDisplay");
        let defaultBgPath = "";
        let lastUsedImage = "";

        // ========= „Éó„É¨„Ç§„É§„Éº =========
        class Player {
            constructor() {
                this.x = canvas.width / 2 - 25;
                this.y = canvas.height - 60;
                this.width = 42; this.height = 50;
                this.dy = 0;
                this.jumpPower = -15;
                this.onGround = true;
                this.image = new Image(); this.image.src = IMG_PATHS.player;
            }

            draw() { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }

            jump() {
                if (this.onGround) {
                    this.dy = this.jumpPower;
                    this.onGround = false;
                    playSound(sounds.jump);
                }
            }

            update() {
                // Ê®™ÁßªÂãïÔºàÊäº„Åó„Å£„Å±„Å™„ÅóÂØæÂøúÔºâ
                if (leftPressed) this.x = Math.max(0, this.x - 5);
                if (rightPressed) this.x = Math.min(canvas.width - this.width, this.x + 5);

                // ÈáçÂäõ & „Ç∏„É£„É≥„Éó
                this.dy += gravity;
                this.y += this.dy;

                if (this.y + this.height >= canvas.height) {
                    this.y = canvas.height - this.height;
                    this.dy = 0;
                    this.onGround = true;
                }

                this.draw();
            }
        }
        // ========= „Ç¢„Ç§„ÉÜ„É† =========
        class Item {
            constructor(type, x, y, speed = 3) {
                this.type = type;
                this.x = x; this.y = y;
                this.width = 30; this.height = 30;
                this.speed = speed * speedMultiplier;
                this.image = new Image(); this.image.src = IMG_PATHS[type];
            }
            draw() { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
            update() { this.y += this.speed; this.draw(); }
        }

        // ========= „Éè„Éº„Éà =========
        function updateHearts() {
            const heartsDiv = document.getElementById("hearts");
            heartsDiv.innerHTML = "";
            for (let i = 0; i < 3; i++) {
                const img = document.createElement("img");
                img.src = (i < lives) ? IMG_PATHS.heart : IMG_PATHS.heartEmpty;
                heartsDiv.appendChild(img);
            }
        }

        // ========= „Ç¢„Ç§„ÉÜ„É†ÁîüÊàê =========
        function spawnItem() {
            if (inKatakanaEvent) return; // ‚òÖ „Ç§„Éô„É≥„Éà‚ë¢‰∏≠„ÅØÈÄöÂ∏∏„Ç¢„Ç§„ÉÜ„É†Âá∫„Åï„Å™„ÅÑ
            const rand = Math.random(); let type;
            if (rand < 0.4) type = "candy"; else if (rand < 0.8) type = "donut"; else type = "bomb";
            items.push(new Item(type, Math.random() * (canvas.width - 30), -30));
        }

        // ========= ÁâπÊÆä„Éë„Çø„Éº„É≥ =========
        function spawnPatternRow() {
            const cols = Math.floor(canvas.width / 30);
            const hole = Math.floor(Math.random() * (cols - 2)); // 3„Éû„ÇπÂàÜÁ©∫„Åë„Çã„ÅÆ„Åß -2
            for (let i = 0; i < cols; i++) {
                if (i < hole || i > hole + 2) {  // 3„Éû„ÇπÈÄ£Á∂ö„ÇíÁ©¥„Å´„Åô„Çã
                    items.push(new Item("bomb", i * 30, -30, 3));
                }
            }
        }

        // „Ç´„Çø„Ç´„ÉäÂΩ¢Áä∂ÂÆöÁæ©Ôºà7√ó7„Éâ„ÉÉ„Éà„ÄÅ1„Éû„Çπ=30pxÔºâ
        const katakanaPatterns = {
            "„Éï": [
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [5, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Ç∏": [
                [0, 0], [2, 0], [4, 0], [6, 0],
                [1, 1],
                [0, 2], [4, 2],
                [1, 3], [5, 3],
                [4, 4],
                [3, 5],
                [0, 6], [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Çµ": [
                [2, 0], [4, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1], [6, 1],
                [2, 2], [4, 2],
                [2, 3], [4, 3],
                [5, 4],
                [4, 5],
                [2, 6], [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Ç≠": [
                [3, 0],
                [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [3, 2],
                [3, 3],
                [1, 4], [2, 4], [3, 4], [4, 4], [5, 4], [6, 4],
                [3, 5],
                [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Éü": [
                [1, 0], [2, 0], [3, 0],
                [4, 1], [5, 1],
                [2, 2],
                [3, 3], [4, 3],
                [1, 5], [2, 5], [3, 5],
                [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„ÇØ": [
                [2, 0],
                [2, 1], [3, 1], [4, 1], [5, 1],
                [1, 2], [5, 2],
                [0, 3], [6, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Ç™": [
                [4, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1], [6, 1],
                [4, 2],
                [3, 3], [4, 3],
                [2, 4], [4, 4],
                [0, 5], [1, 5], [4, 5],
                [3, 6], [4, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Çø": [
                [2, 0],
                [2, 1], [3, 1], [4, 1], [5, 1],
                [1, 2], [5, 2],
                [0, 3], [2, 3], [4, 3], [6, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„É≥": [
                [1, 0],
                [2, 1],
                [6, 2],
                [6, 3],
                [5, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Éß": [
                [1, 2], [2, 2], [3, 2], [4, 2],
                [4, 3],
                [2, 4], [3, 4], [4, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6], [4, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Ç¶": [
                [2, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [0, 2], [5, 2],
                [5, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Éì": [
                [0, 0], [3, 0], [5, 0], [7, 0],
                [0, 1],
                [0, 2], [3, 2], [4, 2],
                [0, 3], [1, 3], [2, 3], [3, 3],
                [0, 4],
                [0, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„É°": [
                [5, 0],
                [5, 1],
                [1, 2], [2, 2], [3, 2], [5, 2],
                [4, 3],
                [3, 4], [5, 4],
                [2, 5], [5, 5],
                [0, 6], [1, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Éá": [
                [1, 0], [2, 0], [3, 0], [4, 0], [6, 0],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2],
                [3, 3],
                [3, 4],
                [3, 5],
                [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "„Éà": [
                [2, 0],
                [2, 1],
                [2, 2],
                [2, 3], [3, 3], [4, 3],
                [2, 4], [4, 4],
                [2, 5],
                [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„ÉÅ": [
                [4, 0], [5, 0],
                [1, 1], [2, 1], [3, 1],
                [3, 2],
                [0, 3], [1, 3], [2, 3], [3, 3], [4, 3], [5, 3], [6, 3],
                [3, 4],
                [3, 5],
                [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„É£": [
                [2, 2],
                [2, 3], [3, 3], [4, 3], [5, 3],
                [2, 4], [5, 4],
                [2, 5], [5, 5],
                [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Çª": [
                [2, 0],
                [2, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2],
                [2, 3], [6, 3],
                [2, 4], [5, 4],
                [2, 5],
                [3, 6], [4, 6], [5, 6], [6, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Ç§": [
                [5, 0],
                [4, 1],
                [3, 2],
                [2, 3], [3, 3],
                [0, 4], [1, 4], [3, 4],
                [3, 5],
                [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "2": [
                [1, 0], [2, 0], [3, 0], [4, 0], [5, 0],
                [0, 1], [6, 1],
                [6, 2],
                [3, 3], [4, 3],
                [1, 4], [2, 4],
                [0, 5],
                [0, 6], [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "0": [
                [1, 0], [2, 0], [3, 0], [4, 0], [5, 0],
                [0, 1], [6, 1],
                [0, 2], [4, 2], [5, 2],
                [0, 3], [1, 3], [4, 3], [5, 3],
                [0, 4], [1, 4], [6, 4],
                [0, 5], [6, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "5": [
                [0, 0], [1, 0], [2, 0], [3, 0], [4, 0], [5, 0],
                [0, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2],
                [0, 3], [5, 3],
                [5, 4],
                [0, 5], [5, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Éù": [
                [3, 0], [5, 0],
                [3, 1], [4, 1], [6, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [5, 2],
                [3, 3],
                [1, 4], [3, 4], [5, 4],
                [0, 5], [3, 5], [6, 5],
                [2, 6], [3, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Çπ": [
                [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [4, 3],
                [4, 4],
                [2, 5], [3, 5], [5, 5],
                [0, 6], [1, 6], [6, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Éº": [
                [0, 3], [1, 3], [2, 3], [3, 3], [4, 3], [5, 3], [6, 3]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Éè": [
                [2, 1], [4, 1],
                [2, 2], [5, 2],
                [2, 3], [5, 3],
                [1, 4], [6, 4],
                [1, 5], [6, 5],
                [0, 6], [6, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„É•": [
                [2, 3], [3, 3], [4, 3],
                [4, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Ç∑": [
                [1, 0], [6, 0],
                [2, 1], [6, 1],
                [1, 2], [6, 2],
                [2, 3], [6, 3],
                [5, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Éñ": [
                [3, 0], [5, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [5, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
            "„É§": [
                [2, 0],
                [2, 1], [4, 1], [5, 1], [6, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [6, 2],
                [2, 3], [5, 3],
                [3, 4],
                [3, 5],
                [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Ç®": [
                [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [3, 2],
                [3, 3],
                [3, 4],
                [0, 5], [1, 5], [2, 5], [3, 5], [4, 5], [5, 5], [6, 5]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Ç≥": [
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [5, 3],
                [5, 4],
                [5, 5],
                [0, 6], [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "„Éä": [
                [3, 0],
                [3, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2],
                [3, 3],
                [3, 4],
                [2, 5],
                [1, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
        };

        // ========= Âá∫„ÅôÈ†ÜÁï™ÔºàÂçòË™û„É™„Çπ„ÉàÔºâ =========
        let katakanaWords = [
            ["„Éï", "„Ç∏", "„Çµ", "„Ç≠", "„Éü", "„ÇØ"],
            ["„Çø", "„É≥", "„Ç∏", "„Éß", "„Ç¶", "„Éì"],
            ["„Ç™", "„É°", "„Éá", "„Éà", "„Ç¶"]
        ];

        let katakanaPatternIndex = 0; // „Å©„ÅÆÂçòË™û„ÇíÂá∫„Åô„ÅãÁÆ°ÁêÜ

        function spawnKatakana(char, isLastChar = false) {
            const pattern = katakanaPatterns[char];
            const startX = canvas.width / 2 - 90; // ‰∏≠Â§ÆÂØÑ„Åõ

            // ‚òÖ „É©„É≥„ÉÄ„É†„Åß„Éè„Éº„Éà„ÇíÁΩÆ„Åè‰ΩçÁΩÆ„ÇíÊ±∫„ÇÅ„ÇãÔºà„Åü„Å†„Åó lives < 3 „ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            let heartIndex = -1;
            if (isLastChar && lives < 3) {
                heartIndex = Math.floor(Math.random() * pattern.length);
            }

            pattern.forEach(([dx, dy], idx) => {
                let type = "star"; // Âü∫Êú¨„ÅØÊòü
                if (idx === heartIndex) {
                    type = "heart";
                }
                items.push(new Item(type, startX + dx, dy - 100, 3));
            });
        }
        // ========= Èõ£ÊòìÂ∫¶Ë®≠ÂÆö =========
        const difficultySettings = {
            1: {
                minSpeed: 5,
                maxSpeed: 9,
                speedInterval: 20,
                dropIntervalBase: 400, // üëà Âü∫Ê∫ñÈñìÈöîÔºàmsÔºâ„ÇíËøΩÂä†
                dropIntervalReduction: 200, // üëà Ê∏õÂ∞ëÈáèÔºàmsÔºâ„ÇíËøΩÂä†
                bgFirst: "images/hint_bg.png",
                bgImages: ["images/bg01.png", "images/bg02.png", "images/bg03.png"],
                bgm: sounds.bgm_easy,
                defaultBg: "images/default_bg.png",
                katakanaWords: [
                    ["„Éï", "„Ç∏", "„Çµ", "„Ç≠", "„Éü", "„ÇØ"],
                    ["„Çª", "„Ç§", "„Çø", "„É≥", "„Çµ", "„Ç§"],
                    ["2", "0", "2", "5"],
                    ["„Éü", "„ÇØ", "„ÉÅ", "„É£", "„É≥"],
                    ["„Ç™", "„Çø", "„É≥", "„Ç∏", "„Éß", "„Ç¶", "„Éì"],
                    ["„Ç™", "„É°", "„Éá", "„Éà", "„Ç¶"]
                ]
            },
            2: {
                minSpeed: 4,
                maxSpeed: 8,
                speedInterval: 20,
                dropIntervalBase: 600,
                dropIntervalReduction: 200,
                bgFirst: "images/hint_bg02.png",
                bgImages: ["images/bg04.png", "images/bg05.png", "images/bg06.png"],
                bgm: sounds.bgm_normal,
                defaultBg: "images/default_bg02.png",
                katakanaWords: [
                    ["„Éü", "„ÇØ", "„ÉÅ", "„É£", "„É≥"],
                    ["„Ç™", "„Çø", "„É≥", "„Ç∏", "„Éß", "„Ç¶", "„Éì"],
                    ["„Ç™", "„É°", "„Éá", "„Éà", "„Ç¶"],
                    ["„Éï", "„Ç∏", "„Çµ", "„Ç≠", "„Éü", "„ÇØ"],
                    ["„Çª", "„Ç§", "„Çø", "„É≥", "„Çµ", "„Ç§"],
                    ["2", "0", "2", "5"],
                ]
            },
            3: {
                minSpeed: 3,
                maxSpeed: 7,
                speedInterval: 20,
                dropIntervalBase: 1000,
                dropIntervalReduction: 200,
                bgFirst: "images/hint_bg03.png",
                bgImages: ["images/bg07.png", "images/bg08.png", "images/bg09.png"],
                bgm: sounds.bgm_hard,
                defaultBg: "images/default_bg03.png",
                katakanaWords: [
                    ["„Éù", "„Çπ", "„Çø", "„Éº", "„Éè"],
                    ["„Éà", "„Ç¶", "„Ç≠", "„É•", "„Ç¶"],
                    ["„Ç∑", "„Éñ", "„É§", "„Ç®", "„Ç≠"],
                    ["„Ç≥", "„Ç¶", "„Éä", "„Ç§"]
                ]
            }
        };

        // ========= „Ç§„Éô„É≥„ÉàÈÄ≤Ë°å =========
        let eventTimers = []; // „Çø„Ç§„Éû„ÉºÁÆ°ÁêÜÁî®
        let inKatakanaEvent = false; // ‚òÖ „Éï„É©„Ç∞ËøΩÂä†
        let currentDifficulty = 1; // „Éá„Éï„Ç©„É´„Éà

        function scheduleEvents() {
            clearEventTimers(); // ‚Üê Âøµ„ÅÆ„Åü„ÇÅÊúÄÂàù„Åß„ÇØ„É™„Ç¢

            const runEvent = () => {
                eventPhase++;
                if (eventPhase % 3 === 1) {
                    // ‚ë† Ê®™‰∏ÄÂàó
                    spawnPatternRow();
                    eventTimers.push(setTimeout(runEvent, 20000)); // 20ÁßíÂæå„Å´‚ë°
                }
                else if (eventPhase % 3 === 2) {
                    // ‚ë° 3ÂõûÈÄ£Á∂öÔºà5Áßí„Åî„Å®Ôºâ
                    let count = 0;
                    const int = setInterval(() => {
                        spawnPatternRow();
                        if (++count >= 3) {
                            clearInterval(int);
                            eventTimers.push(setTimeout(runEvent, 20000)); // 20ÁßíÂæå„Å´‚ë¢
                        }
                    }, 5000);
                    eventTimers.push(int); // interval„ÇÇÁÆ°ÁêÜ
                }
                else if (eventPhase % 3 === 0) {
                    // ‚ë¢ „Ç´„Çø„Ç´„ÉäÊñáÂ≠óÔºàÈ†ÜÁï™„Å´ÂçòË™û„Çí‰ΩøÁî®Ôºâ
                    inKatakanaEvent = true; // ‚òÖ ÈñãÂßãÊôÇ„Å´„Éï„É©„Ç∞ON
                    katakanaIndex = 0;
                    const chars = katakanaWords[katakanaPatternIndex];

                    // ‚òÖËÉåÊôØ„Çí„É©„É≥„ÉÄ„É†„Å´„Éï„É™„ÉÉ„ÉóÂ§âÊõ¥
                    setBackgroundShuffledWithFlip();

                    const nextChar = () => {
                        if (!gameRunning) return;
                        if (katakanaIndex < chars.length) {
                            const isLastChar = (katakanaIndex === chars.length - 1);
                            spawnKatakana(chars[katakanaIndex], isLastChar); // ‚ÜêËøΩÂä†
                            katakanaIndex++;
                            const t = setTimeout(nextChar, 2000); // ‚òÖ Â§âÊï∞„Å´ÂÖ•„Çå„Çã
                            eventTimers.push(t);                  // ‚òÖ ÁÆ°ÁêÜ„É™„Çπ„Éà„Å´ËøΩÂä†
                        } else {
                            // ‚òÖ „Ç§„Éô„É≥„Éà‚ë¢ÁµÇ‰∫Ü ‚Üí „Éï„É©„Ç∞OFF
                            inKatakanaEvent = false;

                            const resetT = setTimeout(() => {
                                resetBackgroundWithFlip();

                                minSpeed += 1;
                                speedLevel = minSpeed;
                                adjustDropRate(true);

                                gameStartTime = Date.now();
                            }, 2000);
                            eventTimers.push(resetT);

                            const t = setTimeout(runEvent, 10000); // ‚òÖ Â§âÊï∞„Å´ÂÖ•„Çå„Çã
                            eventTimers.push(t);                   // ‚òÖ ÁÆ°ÁêÜ„É™„Çπ„Éà„Å´ËøΩÂä†
                            katakanaPatternIndex = (katakanaPatternIndex + 1) % katakanaWords.length;
                        }
                    };
                    nextChar();
                }
            };

            // ÂàùÂõû„ÅØ20ÁßíÂæÖ„Å£„Å¶„Åã„Çâ‚ë†„ÇíÁô∫Áîü
            eventTimers.push(setTimeout(runEvent, 20000));
        }



        // ========= „Ç≤„Éº„É†ÈÄ≤Ë°å =========
        let gameStartTime = Date.now();
        let speedLevel = 3;  // ÂàùÊúü„Çπ„Éî„Éº„Éâ
        let minSpeed = 3;     // ÂàùÊúüÂÄ§
        let maxSpeed = 7;     // ‰∏äÈôê„Çπ„Éî„Éº„Éâ
        let speedInterval = 20; // ‰∏äÊòáÈñìÈöîÔºàÁßíÔºâ

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            player.update();

            difficultyDisplay.textContent = "Level: " + currentDifficulty;

            // ÁµåÈÅéÊôÇÈñì„Åß„Çπ„Éî„Éº„ÉâË™øÊï¥
            const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
            let newSpeed = minSpeed + Math.floor(elapsed / speedInterval);

            if (newSpeed !== speedLevel) {
                speedLevel = newSpeed;
                adjustDropRate(); // Âá∫ÁèæÈñìÈöî„ÇÇË™øÊï¥
            }

            items.forEach((item, i) => {
                item.speed = speedLevel * (downPressed ? 2 : 1);  // ‚òÖ ‰∏ã„Ç≠„Éº„ÅßÂÄçÈÄü
                item.update();
                if (collision(player, item)) {
                    if (item.type === "candy") {
                        score += 3;
                        playSound(sounds.item);
                    } else if (item.type === "donut") {
                        score += 9;
                        playSound(sounds.item);
                    } else if (item.type === "star") {
                        score += 50000000;
                        playSound(sounds.star);
                    } else if (item.type === "heart") {
                        if (lives < 3) { // ‚òÖ ÊúÄÂ§ßÂÄ§‰ª•‰∏ä„ÅØÂ¢ó„Åà„Å™„ÅÑ
                            lives++;
                            updateHearts();
                        }
                        playSound(sounds.heart);
                        items.splice(i, 1);
                    } else {
                        lives--;
                        updateHearts();
                        playSound(sounds.damage);
                        if (lives <= 0) endGame("„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº");
                    }
                    items.splice(i, 1);
                } else if (item.y > canvas.height) {
                    items.splice(i, 1);
                }
            });

            // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
            document.getElementById("score").textContent = "Score: " + score;

            // ‚òÖ „ÇØ„É™„Ç¢Âà§ÂÆö
            if (score >= 10000000000) {
                endGame("100ÂÑÑÁÇπÈÅîÊàêÔºÅ");
            }
        }

        function collision(a, b) {
            return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
        }

        function clearEventTimers() {
            eventTimers.forEach(t => {
                clearTimeout(t);
                clearInterval(t);
            });
            eventTimers = [];
        }

        // ========= „Ç≤„Éº„É†ÈñãÂßã/ÁµÇ‰∫Ü =========
        function initGame() {
            player = new Player(); items = []; score = 0; lives = 3; speedMultiplier = 1;
            eventPhase = 0; katakanaIndex = 0;
            katakanaPatternIndex = 0; // ‚Üê „Åì„Çå„ÇÇÂøò„Çå„Åö
            inKatakanaEvent = false;  // ‚Üê Âøµ„ÅÆ„Åü„ÇÅ„É™„Çª„ÉÉ„Éà
            clearEventTimers();       // ‚Üê „Çø„Ç§„Éû„ÉºÂÆåÂÖ®Ê∂àÂéª

            document.getElementById("score").textContent = "Score: 0";
            updateHearts();

            // ‰∏°Êñπ„ÅÆÁîªÈù¢„ÇíÊ∂à„Åô
            document.getElementById("gameOverScreen").style.display = "none";
            document.getElementById("clearScreen").style.display = "none";
        }

        let currentBgm = null;

        function startGame() {
            document.getElementById("startScreen").style.display = "none";
            document.getElementById("gameOverScreen").style.display = "none";
            document.getElementById("clearScreen").style.display = "none";
            document.getElementById("difficultyModal").style.display = "none";
            if ("ontouchstart" in window || navigator.maxTouchPoints > 0) {
                document.getElementById("controls").style.display = "flex";
            }
            // üéØ ÂÖà„Å´Èõ£ÊòìÂ∫¶Ë®≠ÂÆö„ÇíÂèçÊò†
            const setting = difficultySettings[currentDifficulty];
            minSpeed = setting.minSpeed;
            speedLevel = setting.minSpeed;
            maxSpeed = setting.maxSpeed;
            bgImages = setting.bgImages;
            sounds.bgm = setting.bgm;
            katakanaWords = setting.katakanaWords;

            // üéØ „Åì„Åì„ÇíËøΩÂä†
            defaultBgPath = setting.defaultBg;
            bgLayer.style.backgroundImage = `url(${defaultBgPath})`;
            shuffledImages = shuffleArray(bgImages); // Êñ∞„Åó„ÅÑÈõ£ÊòìÂ∫¶„ÅÆÁîªÂÉè„Çí„Ç∑„É£„ÉÉ„Éï„É´
            firstBgUsed = false; // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà

            // üéØ Èõ£ÊòìÂ∫¶„ÅåÂèçÊò†„Åï„Çå„ÅüÁä∂ÊÖã„ÅßÂàùÊúüÂåñ
            initGame();
            gameRunning = true;
            gameStartTime = Date.now();

            gameInterval = setInterval(gameLoop, 30);
            adjustDropRate(); // ÊúÄÂàù„ÅÆÂá∫ÁèæÈñìÈöî„Çí„Çª„ÉÉ„Éà

            clearEventTimers();   // ‚Üê ÂâçÂõû„ÅÆ„Çø„Ç§„Éû„Éº„ÇíÂøÖ„ÅöÂâäÈô§
            scheduleEvents();
            // BGMÂàáÊõø
            if (currentBgm) {
                currentBgm.pause(); // Êó¢Â≠ò„ÅÆBGM„ÇíÂÅúÊ≠¢
            }
            currentBgm = setting.bgm; // Êñ∞„Åó„ÅÑBGM„Çí„Çª„ÉÉ„Éà

            if (currentBgm) {
                // BGM„ÅÆ„É´„Éº„Éó„Å®Èü≥Èáè„ÇíË®≠ÂÆö
                currentBgm.loop = true;
                currentBgm.volume = 0.1; // Èü≥ÈáèË™øÊï¥Ôºà0.0„Äú1.0Ôºâ

                currentBgm.currentTime = 0;
                currentBgm.play();
            }
        }

        function endGame(status = "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº") {
            gameRunning = false;
            clearInterval(gameInterval);
            clearInterval(dropInterval);
            clearEventTimers();

            // ‚òÖ „Ç§„Éô„É≥„Éà„Çø„Ç§„Éû„Éº„ÇíÂÖ®ÂÅúÊ≠¢
            eventTimers.forEach(t => clearTimeout(t));
            eventTimers = [];

            document.getElementById("controls").style.display = "none";

            // BGMÂÅúÊ≠¢
            if (currentBgm) {
                currentBgm.pause();
            }

            // ÂäπÊûúÈü≥
            if (status === "„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ") {
                playSound(sounds.clear);
                document.getElementById("clearTitle").textContent = status;
                document.getElementById("finalClearScore").textContent = "Score: " + score;
                document.getElementById("clearScreen").style.display = "flex";
            } else {
                playSound(sounds.gameover);
                document.getElementById("endTitle").textContent = status;
                document.getElementById("finalScore").textContent = "Score: " + score;
                document.getElementById("gameOverScreen").style.display = "flex";
            }

            // ‚òÖ XÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁîüÊàê
            const gameUrl = encodeURIComponent("https://www.google.com/?hl=ja"); // „Ç≤„Éº„É†„ÇíÂÖ¨Èñã„Åô„ÇãURL„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
            const scoreMessage = `Áâ°Ë†£„Çµ„Éº„É¢„É≥„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É†„Åß„Çπ„Ç≥„Ç¢${score}ÁÇπ„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅ`;
            const hashtags = ["Áâ°Ë†£„Çµ„Éº„É¢„É≥„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É†", "Ëó§Â¥éÂõ£Ê¥ªÂãïÂ†±Âëä", "Ëó§Â¥éÊú™Êù•ÁîüË™ïÁ•≠2025"];
            const formattedHashtags = hashtags.map(tag => `#${tag}`).join(" ");
            const shareText = encodeURIComponent(scoreMessage + "\n" + formattedHashtags);

            // „Ç¢„Éó„É™Áî®„Å®WebÁâàÁî®„ÅÆURL„Çí‰∏°ÊñπÁîüÊàê
            const shareUrlApp = `twitter://post?text=${shareText}&url=${gameUrl}`;
            const shareUrlWeb = `https://twitter.com/intent/tweet?text=${shareText}&url=${gameUrl}`;

            // „Éú„Çø„É≥„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
            const shareBtn = document.getElementById("shareBtn");
            const shareBtnTop = document.getElementById("shareBtn_top");

            // „Ç¢„Éó„É™„Åå„ÅÇ„Çå„Å∞„Ç¢„Éó„É™„Åß„ÄÅ„Å™„Åë„Çå„Å∞WebÁâà„ÅßÈñã„Åè
            shareBtn.onclick = () => {
                // PC„ÇÑ„Ç¢„Éó„É™„Åå„Å™„ÅÑÂ†¥Âêà„Å´ÂÇô„Åà„ÄÅ„Åæ„ÅöWebÁâà„ÇíÈñã„Åè
                const newWindow = window.open(shareUrlWeb, "_blank");

                // „Çπ„Éû„Éõ„Åß„Ç¢„Éó„É™„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„ÄÅ„Åù„Å°„Çâ„ÇíÂÑ™ÂÖà
                if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) && newWindow) {
                    // „Ç¢„Éó„É™„Å∏„ÅÆ„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„ÇíË©¶Ë°å
                    newWindow.location.href = shareUrlApp;
                }
            };

            shareBtnTop.onclick = () => {
                const newWindow = window.open(shareUrlWeb, "_blank");
                if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) && newWindow) {
                    newWindow.location.href = shareUrlApp;
                }
            };
        }
        }

        // ========= „Ç¢„Ç§„ÉÜ„É†Âá∫ÁèæÈñìÈöîË™øÊï¥ =========
        function adjustDropRate(reset = false) {
            clearInterval(dropInterval);
            const setting = difficultySettings[currentDifficulty]; // üëà Èõ£ÊòìÂ∫¶Ë®≠ÂÆö„ÇíÂèñÂæó

            if (reset) {
                // ÂàùÊúü„ÅÆÂá∫ÁèæÈñìÈöî„Å´Êàª„ÅôÔºà‰æã: 1000msÔºâ
                dropInterval = setInterval(spawnItem, setting.dropIntervalBase); // üëà Èõ£ÊòìÂ∫¶„Åî„Å®„ÅÆÂü∫Ê∫ñÈñìÈöî„Çí‰ΩøÁî®
            } else {
                // üéØ Êñ∞„Åó„ÅÑË®àÁÆóÂºè
                const interval = Math.max(300, setting.dropIntervalBase / speedLevel);
                dropInterval = setInterval(spawnItem, interval);

            }
        }

        // ========= Êìç‰Ωú =========
        let leftPressed = false;
        let rightPressed = false;
        let downPressed = false;

        document.addEventListener("keydown", e => {
            if (!gameRunning) return;

            if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") leftPressed = true;
            if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") rightPressed = true;
            if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") downPressed = true;
            if (e.key === " " || e.key === "ArrowUp" || e.key.toLowerCase() === "w") player.jump();
        });

        document.addEventListener("keyup", e => {
            if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") leftPressed = false;
            if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") rightPressed = false;
            if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") downPressed = false;
        });


        // ========= „Çπ„Éû„ÉõÊìç‰ΩúÔºà„Éû„É´„ÉÅ„Çø„ÉÉ„ÉÅÂØæÂøúÔºâ =========
        let activeTouches = {
            left: null,
            right: null
        };

        document.getElementById("leftBtn").addEventListener("touchstart", e => {
            e.preventDefault();
            if (!gameRunning) return;
            if (activeTouches.left === null) {
                activeTouches.left = e.changedTouches[0].identifier;
                leftPressed = true;
            }
        });

        document.getElementById("leftBtn").addEventListener("touchend", e => {
            [...e.changedTouches].forEach(touch => {
                if (touch.identifier === activeTouches.left) {
                    leftPressed = false;
                    activeTouches.left = null;
                }
            });
        });

        document.getElementById("rightBtn").addEventListener("touchstart", e => {
            e.preventDefault();
            if (!gameRunning) return;
            if (activeTouches.right === null) {
                activeTouches.right = e.changedTouches[0].identifier;
                rightPressed = true;
            }
        });

        document.getElementById("rightBtn").addEventListener("touchend", e => {
            [...e.changedTouches].forEach(touch => {
                if (touch.identifier === activeTouches.right) {
                    rightPressed = false;
                    activeTouches.right = null;
                }
            });
        });

        // „Ç∏„É£„É≥„Éó„ÅØÂçòÁô∫„Å™„ÅÆ„ÅßÂçòÁ¥î„ÅßOK
        document.getElementById("jumpBtn").addEventListener("touchstart", e => {
            e.preventDefault();
            if (gameRunning) player.jump();
        });

        // ========= „Éú„Çø„É≥ =========
        const startBtn = document.getElementById("startBtn");
        const startBtnText = document.getElementById("startBtnText");
        const difficultyModal = document.getElementById("difficultyModal");
        let isModalOpen = false;

        // „ÄåÈÅä„Å∂„Äç/„ÄåÈñâ„Åò„Çã„Äç„Éú„Çø„É≥„ÅÆ„Éà„Ç∞„É´Ê©üËÉΩ
        startBtn.addEventListener("click", () => {
            if (isModalOpen) {
                // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà ‚Üí Èñâ„Åò„Çã
                difficultyModal.style.display = "none";
                startBtnText.textContent = "ÈÅä„Å∂";
                isModalOpen = false;
            } else {
                // „É¢„Éº„ÉÄ„É´„ÅåÈñâ„Åò„Å¶„ÅÑ„ÇãÂ†¥Âêà ‚Üí Èñã„Åè
                difficultyModal.style.display = "block";
                startBtnText.textContent = "Èñâ„Åò„Çã";
                isModalOpen = true;
            }
        });

        // Èõ£ÊòìÂ∫¶„Éú„Çø„É≥Êäº„Åó„Åü„Çâ„Ç≤„Éº„É†ÈñãÂßã
        document.querySelectorAll(".diffBtn").forEach(btn => {
            btn.addEventListener("click", e => {
                currentDifficulty = parseInt(e.target.dataset.level);
                difficultyModal.style.display = "none";
                startBtnText.textContent = "ÈÅä„Å∂"; // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„ÅØ„Éú„Çø„É≥„Çí„ÄåÈÅä„Å∂„Äç„Å´Êàª„Åô
                isModalOpen = false;
                startGame();
            });
        });

        document.getElementById("retryBtn").onclick = startGame;
        document.getElementById("retryBtn_agein").onclick = startGame;
        document.getElementById("backToStartBtn").onclick = () => {
            document.getElementById("gameOverScreen").style.display = "none";
            document.getElementById("startScreen").style.display = "flex";
        };
        document.getElementById("backToStartBtn_top").onclick = () => {
            document.getElementById("clearScreen").style.display = "none";
            document.getElementById("startScreen").style.display = "flex";
        };

    </script>
</body>


</html>