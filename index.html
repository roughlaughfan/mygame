<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
    <title>ç‰¡è £ã‚µãƒ¼ãƒ¢ãƒ³ã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ </title>
    <link href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap');
        body {
            margin: 0;
            overflow: hidden;
            background: #f0f0f0;
            font-family: "Noto Sans JP", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
        }

        #main {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #main .main_wrap {
            width: 100%;
            max-width: 480px;
            height: auto;
            margin: auto;
            position: relative;
            perspective: 1000px;
            overflow: hidden;
            background: url("images/start.png") no-repeat center center;
            background-size: 100% auto;
            aspect-ratio: 3 / 4;
        }

        canvas {
            display: block;
            margin: auto;
            position: relative;
            z-index: 1;
            height: 100%;
            width: auto;
            aspect-ratio: 3 / 4;
        }

        #bgLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /*background-image: url("images/default_bg.png");*/
            background-size: cover;
            background-position: center;
            transition: transform 0.6s ease;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        #startScreen,
        #gameOverScreen,
        #clearScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: url("images/start.png") no-repeat center center;
            color: white;
            z-index: 10;
            padding: 10% 15%;
            box-sizing: border-box;
            color: rgb(52, 52, 52);
            background-size: 100% 100%;
        }

        #startScreen {
            background-image: url("images/start.png");
        }

        #gameOverScreen {
            background-image: url("images/gameover.png");
        }

        #clearScreen {
            background-image: url("images/clear.png");
        }

        #hearts {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 2;
        }

        #hearts img {
            width: 30px;
            height: 30px;
        }

        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            z-index: 3;
            text-shadow:
                1px 1px 0 #FFF,
                -1px 1px 0 #FFF,
                -1px -1px 0 #FFF,
                1px -1px 0 #FFF;
        }

        #difficultyDisplay {
            position: absolute;
            top: 10px;
            left: 150px;
            font-size: 24px;
            z-index: 3;
            text-shadow:
                1px 1px 0 #FFF,
                -1px 1px 0 #FFF,
                -1px -1px 0 #FFF,
                1px -1px 0 #FFF;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .ctrl-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #leftRight {
            display: flex;
            gap: 20px;
        }

        #finalScore,
        #finalClearScore {
            margin: 0 auto;
        }

        .btn {
            display: block;
            width: 100%;
            background: #0054ed;
            color: #FFF;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 3em;
            font-size: 20px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            transition: opacity 0.3s ease;
            user-select: none;
        }

        .x_share {
            display: flex;
            position: relative;
            margin-bottom: 0.5em;
            align-items: center;
        }

        .btn-sns {
            position: relative;
            width: 10px;
            height: 10px;
            padding: 1rem;
            display: inline-block;
            cursor: pointer;
        }

        .svg-icon {
            display: grid;
            place-content: center;
            position: absolute;
            inset: 0;
            margin: auto;
            transition: transform 0.5s ease;
            backface-visibility: hidden;
        }

        .svg-icon svg {
            width: 20px;
            height: 20px;
        }

        .svg-left {
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
            background-color: #000;
            border-radius: 50%;
        }

        .svg-right {
            clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);
            background-color: #000;
            border-radius: 50%;
        }


        .svg-icon svg {
            fill: #fff;
        }

        .svg-icon:last-child svg {
            transform: scale(0);
            transition: transform 1s;
        }


        /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®š */
        .btn-sns:hover .svg-left {
            transform: translateX(-20%) rotateY(-90deg);
        }

        .btn-sns:hover .svg-right {
            transform: translateX(20%) rotateY(90deg);
        }

        .btn-sns:hover .svg-icon:last-child svg {
            transform: scale(1.2);
            fill: #1da1f1;
        }

        .btn:hover {
            opacity: .7;
        }

        h1 {
            color: #0054ed;
        }

        #score,
        #hearts,
        #difficultyDisplay,
        h1,
        h2,
        p,
        h1+p,
        h2+p,
        p.img {
            user-select: none;
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 80%;
        }

        .modal .btn {
            margin: 10px auto;
            width: 80%;
        }

        @media (max-height: 639px) {
            #main .main_wrap {
                height: 100%;
                width: auto;
                min-height: 350px;
            }
            h1 {
                font-size: 3.5vh;
            }

            h2 {
                font-size: 3.2vh;
            }

            h1+p,
            h2+p,
            .btn,
            #score,
            #difficultyDisplay,
            .x_share {
                font-size: 3vh;
            }
            p.img {
                text-align: center;
            }
            p.img img{
                width: 80%;
            }
            .modal {
                padding: 2.8vh;
            }
            #hearts img {
                width: 3.5vh;
                height: 3.5vh;
            }
            #difficultyDisplay {
                left: 40%;
            }
        }
        @media (max-width: 479px) {
            #main .main_wrap {
                margin: 0 auto auto;
                max-height: none;
                height: auto;
                aspect-ratio: 3 / 4;
            }

            canvas {
                width: 100%;
                height: auto;
            }

            #startScreen img,
            #gameOverScreen img,
            #clearScreen img {
                width: 70%;
                display: block;
                margin: 0 auto;
            }

            h1 {
                font-size: 7vw;
            }

            h2 {
                font-size: 5vw;
            }

            h1+p,
            h2+p,
            .btn,
            #score,
            #difficultyDisplay,
            .x_share {
                font-size: 3.5vw;
            }
        }
    </style>
</head>

<body>
    <div id="main">
        <div class="main_wrap" id="main_wrap">
            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
            <div id="startScreen">
                <h1>ç‰¡è £ã‚µãƒ¼ãƒ¢ãƒ³ã‚­ãƒ£ãƒƒãƒ</h1>
                <p>ã¿ãã¡ã‚ƒã‚“ã®å¥½ããªç‰¡è £ã‚„ã‚µãƒ¼ãƒ¢ãƒ³å¯¿å¸ã‚’ãŸãã•ã‚“é›†ã‚ã¦ã¿ãã¡ã‚ƒã‚“ã«ä¼šã„ã«è¡Œã“ã†ï¼</p>
                <p class="img"><img src="images/start_img.png" alt=""></p>
                <a id="startBtn" class="btn"><span id="startBtnText">éŠã¶</span></a>
            </div>
            <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
            <div id="gameOverScreen" style="display:none;">
                <h1 id="endTitle">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
                <p class="img"><img src="images/gameover_img.png" alt=""></p>
                <p id="finalScore"></p>
                <div class="x_share">Xã§çµæœã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼â†’ã€€
                    <a class="btn-sns" id="shareBtn">
                        <div class="svg-icon svg-left">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon svg-right">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                                </path>
                            </svg>
                        </div>
                    </a>
                </div>
                <a class="btn" id="retryBtn">ãƒªãƒˆãƒ©ã‚¤</a>
                <a class="btn" id="backToStartBtn">ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹</a>
            </div>
            <!-- ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ -->
            <div id="clearScreen" style="display:none;">
                <h1 id="clearTitle">ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼</h1>
                <p class="img"><img src="images/clear_img.png" alt=""></p>
                <p id="finalClearScore"></p>
                <div class="x_share">Xã§çµæœã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼â†’ã€€<a class="btn-sns" id="shareBtn_top">
                        <div class="svg-icon svg-left">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon svg-right">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z">
                                </path>
                            </svg>
                        </div>
                        <div class="svg-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path
                                    d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                                </path>
                            </svg>
                        </div>
                    </a></div>
                <a class="btn" id="retryBtn_agein">ã‚‚ã†ä¸€åº¦</a>
                <a class="btn" id="backToStartBtn_top">ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹</a>
            </div>

            <!-- é›£æ˜“åº¦é¸æŠã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
            <div id="difficultyModal" style="display:none;" class="modal">
                <h2>é›£æ˜“åº¦ã‚’é¸ã‚“ã§ã­</h2>
                <p>â˜…é–‹ç™ºå‘ã‘ï¼šæ™‚æœŸã«åˆã‚ã›ã¦ãƒœã‚¿ãƒ³ã‚’å…¬é–‹</p>
                <a class="btn diffBtn" data-level="1">ç¬¬ä¸€å¼¾ï¼ˆé›£ã—ã„ï¼‰</a>
                <a class="btn diffBtn" data-level="2">ç¬¬äºŒå¼¾ï¼ˆãµã¤ã†ï¼‰</a>
                <a class="btn diffBtn" data-level="3">ç¬¬ä¸‰å¼¾ï¼ˆç°¡å˜ï¼‰</a>
            </div>

            <div id="bgLayer"></div>
            <canvas id="gameCanvas" width="480" height="640"></canvas>
            <div id="hearts"></div>
            <div id="difficultyDisplay">Level: 1</div>
            <div id="score">Score: 0</div>
        </div>
    </div>

    <!-- ã‚¹ãƒãƒ›ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
    <div id="controls" style="display:none;">
        <div id="leftRight">
            <a class="ctrl-btn" id="leftBtn">â†</a>
            <a class="ctrl-btn" id="rightBtn">â†’</a>
        </div>
        <a class="ctrl-btn" id="jumpBtn">â¤´</a>
    </div>

    <script>
        // ========= ç”»åƒ =========
        const IMG_PATHS = {
            player: "images/player.png",
            candy: "images/candy.png",
            donut: "images/donut.png",
            bomb: "images/bomb.png",
            heart: "images/heart.png",
            heartEmpty: "images/heart_empty.png",
            star: "images/star.png"
        };

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // ========= éŸ³æ¥½ =========
        const sounds = {
            jump: new Audio("sounds/jump.mp3"),
            damage: new Audio("sounds/damage.mp3"),
            item: new Audio("sounds/item.mp3"),
            heart: new Audio("sounds/heart.mp3"),
            gameover: new Audio("sounds/gameover.mp3"), // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”¨
            clear: new Audio("sounds/clear.mp3"),       // ã‚¯ãƒªã‚¢ç”¨
            bgm: new Audio("sounds/bgm.mp3"),
            bgm_easy: new Audio("sounds/bgm.mp3"),
            bgm_normal: new Audio("sounds/bgm.mp3"),
            bgm_hard: new Audio("sounds/bgm.mp3")
        };

        // éŸ³ã‚’é‡ã­ã¦é³´ã‚‰ã™ãŸã‚ã«æ¯å› clone ã—ã¦å†ç”Ÿ
        function playSound(audio) {
            const s = audio.cloneNode();
            s.volume = 0.4; // éŸ³é‡èª¿æ•´
            s.play();
        }

        // ãƒ«ãƒ¼ãƒ—å†ç”Ÿè¨­å®š
        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.1; // éŸ³é‡èª¿æ•´ï¼ˆ0.0ã€œ1.0ï¼‰

        // ========= èƒŒæ™¯ç®¡ç† =========
        let bgImages = [
            "images/bg01.png",
            "images/bg02.png",
            "images/bg03.png",
            "images/bg04.png",
            "images/bg05.png"
        ]; // ãƒ©ãƒ³ãƒ€ãƒ ã«ä½¿ã†èƒŒæ™¯ç”»åƒ

        const bgLayer = document.getElementById("bgLayer");
        let shuffledImages = [];
        let firstBgUsed = false;

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°ï¼ˆFisherâ€“Yatesï¼‰
        function shuffleArray(array) {
            let arr = array.slice();
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function setBackgroundShuffledWithFlip() {
            let img;
            const setting = difficultySettings[currentDifficulty]; // ğŸ‘ˆ ã“ã®è¡Œã‚’è¿½åŠ 

            if (!firstBgUsed) {
                // â˜… æœ€åˆã ã‘å›ºå®šã®èƒŒæ™¯ã‚’ä½¿ç”¨
                img = setting.bgFirst;
                firstBgUsed = true;
            } else {
                // ç”»åƒãŒå°½ããŸã‚‰å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                if (shuffledImages.length === 0) {
                    shuffledImages = shuffleArray(bgImages);
                }

                // æ¬¡ã®ç”»åƒã‚’å–ã‚Šå‡ºã—
                img = shuffledImages.shift();
            }

            // 0 â†’ 180åº¦ å›è»¢ï¼ˆè£å´ã¸ï¼‰
            bgLayer.style.transform = "rotateY(180deg)";

            setTimeout(() => {
                // ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆ
                bgLayer.style.backgroundImage = `url(${img})`;

                // 360åº¦ã¾ã§å›è»¢ã—ã¦æ­£é¢ã«æˆ»ã™
                bgLayer.style.transform = "rotateY(360deg)";
            }, 300);
        }

        function resetBackgroundWithFlip() {
            // 0 â†’ 180åº¦ å›è»¢
            bgLayer.style.transform = "rotateY(180deg)";

            setTimeout(() => {
                // è£å´ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã«åˆ‡ã‚Šæ›¿ãˆ
                bgLayer.style.backgroundImage = `url(${defaultBgPath})`

                // 360åº¦ã«æˆ»ã™
                bgLayer.style.transform = "rotateY(360deg)";
            }, 300);
        }

        // ========= ã‚°ãƒ­ãƒ¼ãƒãƒ« =========
        let player, items, score, lives, gameInterval, dropInterval, speedMultiplier, gameRunning = false;
        let eventTimer, eventPhase = 0, katakanaIndex = 0;
        const gravity = 1;
        const difficultyDisplay = document.getElementById("difficultyDisplay");
        let defaultBgPath = "";

        // ========= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ =========
        class Player {
            constructor() {
                this.x = canvas.width / 2 - 25;
                this.y = canvas.height - 60;
                this.width = 42; this.height = 50;
                this.dy = 0;
                this.jumpPower = -15;
                this.onGround = true;
                this.image = new Image(); this.image.src = IMG_PATHS.player;
            }

            draw() { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }

            jump() {
                if (this.onGround) {
                    this.dy = this.jumpPower;
                    this.onGround = false;
                    playSound(sounds.jump);
                }
            }

            update() {
                // æ¨ªç§»å‹•ï¼ˆæŠ¼ã—ã£ã±ãªã—å¯¾å¿œï¼‰
                if (leftPressed) this.x = Math.max(0, this.x - 5);
                if (rightPressed) this.x = Math.min(canvas.width - this.width, this.x + 5);

                // é‡åŠ› & ã‚¸ãƒ£ãƒ³ãƒ—
                this.dy += gravity;
                this.y += this.dy;

                if (this.y + this.height >= canvas.height) {
                    this.y = canvas.height - this.height;
                    this.dy = 0;
                    this.onGround = true;
                }

                this.draw();
            }
        }
        // ========= ã‚¢ã‚¤ãƒ†ãƒ  =========
        class Item {
            constructor(type, x, y, speed = 3) {
                this.type = type;
                this.x = x; this.y = y;
                this.width = 30; this.height = 30;
                this.speed = speed * speedMultiplier;
                this.image = new Image(); this.image.src = IMG_PATHS[type];
            }
            draw() { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
            update() { this.y += this.speed; this.draw(); }
        }

        // ========= ãƒãƒ¼ãƒˆ =========
        function updateHearts() {
            const heartsDiv = document.getElementById("hearts");
            heartsDiv.innerHTML = "";
            for (let i = 0; i < 3; i++) {
                const img = document.createElement("img");
                img.src = (i < lives) ? IMG_PATHS.heart : IMG_PATHS.heartEmpty;
                heartsDiv.appendChild(img);
            }
        }

        // ========= ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ =========
        function spawnItem() {
            if (inKatakanaEvent) return; // â˜… ã‚¤ãƒ™ãƒ³ãƒˆâ‘¢ä¸­ã¯é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ å‡ºã•ãªã„
            const rand = Math.random(); let type;
            if (rand < 0.4) type = "candy"; else if (rand < 0.8) type = "donut"; else type = "bomb";
            items.push(new Item(type, Math.random() * (canvas.width - 30), -30));
        }

        // ========= ç‰¹æ®Šãƒ‘ã‚¿ãƒ¼ãƒ³ =========
        function spawnPatternRow() {
            const cols = Math.floor(canvas.width / 30);
            const hole = Math.floor(Math.random() * (cols - 2)); // 3ãƒã‚¹åˆ†ç©ºã‘ã‚‹ã®ã§ -2
            for (let i = 0; i < cols; i++) {
                if (i < hole || i > hole + 2) {  // 3ãƒã‚¹é€£ç¶šã‚’ç©´ã«ã™ã‚‹
                    items.push(new Item("bomb", i * 30, -30, 3));
                }
            }
        }

        // ã‚«ã‚¿ã‚«ãƒŠå½¢çŠ¶å®šç¾©ï¼ˆ7Ã—7ãƒ‰ãƒƒãƒˆã€1ãƒã‚¹=30pxï¼‰
        const katakanaPatterns = {
            "ãƒ•": [
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [5, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚¸": [
                [0, 0], [2, 0], [4, 0], [6, 0],
                [1, 1],
                [0, 2], [4, 2],
                [1, 3], [5, 3],
                [4, 4],
                [3, 5],
                [0, 6], [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚µ": [
                [2, 0], [4, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1], [6, 1],
                [2, 2], [4, 2],
                [2, 3], [4, 3],
                [5, 4],
                [4, 5],
                [2, 6], [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚­": [
                [3, 0],
                [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [3, 2],
                [3, 3],
                [1, 4], [2, 4], [3, 4], [4, 4], [5, 4], [6, 4],
                [3, 5],
                [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒŸ": [
                [1, 0], [2, 0], [3, 0],
                [4, 1], [5, 1],
                [2, 2],
                [3, 3], [4, 3],
                [1, 5], [2, 5], [3, 5],
                [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚¯": [
                [2, 0],
                [2, 1], [3, 1], [4, 1], [5, 1],
                [1, 2], [5, 2],
                [0, 3], [6, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚ª": [
                [4, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1], [6, 1],
                [4, 2],
                [3, 3], [4, 3],
                [2, 4], [4, 4],
                [0, 5], [1, 5], [4, 5],
                [3, 6], [4, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚¿": [
                [2, 0],
                [2, 1], [3, 1], [4, 1], [5, 1],
                [1, 2], [5, 2],
                [0, 3], [2, 3], [4, 3], [6, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒ³": [
                [1, 0],
                [2, 1],
                [6, 2],
                [6, 3],
                [5, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒ§": [
                [1, 2], [2, 2], [3, 2], [4, 2],
                [4, 3],
                [2, 4], [3, 4], [4, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6], [4, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ã‚¦": [
                [2, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [0, 2], [5, 2],
                [5, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒ“": [
                [0, 0], [3, 0], [5, 0], [7, 0],
                [0, 1],
                [0, 2], [3, 2], [4, 2],
                [0, 3], [1, 3], [2, 3], [3, 3],
                [0, 4],
                [0, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒ¡": [
                [5, 0],
                [5, 1],
                [1, 2], [2, 2], [3, 2], [5, 2],
                [4, 3],
                [3, 4], [5, 4],
                [2, 5], [5, 5],
                [0, 6], [1, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒ‡": [
                [1, 0], [2, 0], [3, 0], [4, 0], [6, 0],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2],
                [3, 3],
                [3, 4],
                [3, 5],
                [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),

            "ãƒˆ": [
                [2, 0],
                [2, 1],
                [2, 2],
                [2, 3], [3, 3], [4, 3],
                [2, 4], [4, 4],
                [2, 5],
                [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ": [
                [4, 0], [5, 0],
                [1, 1], [2, 1], [3, 1],
                [3, 2],
                [0, 3], [1, 3], [2, 3], [3, 3], [4, 3], [5, 3], [6, 3],
                [3, 4],
                [3, 5],
                [2, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ£": [
                [2, 2],
                [2, 3], [3, 3], [4, 3], [5, 3],
                [2, 4], [5, 4],
                [2, 5], [5, 5],
                [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ã‚»": [
                [2, 0],
                [2, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2],
                [2, 3], [6, 3],
                [2, 4], [5, 4],
                [2, 5],
                [3, 6], [4, 6], [5, 6], [6, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ã‚¤": [
                [5, 0],
                [4, 1],
                [3, 2],
                [2, 3], [3, 3],
                [0, 4], [1, 4], [3, 4],
                [3, 5],
                [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "2": [
                [1, 0], [2, 0], [3, 0], [4, 0], [5, 0],
                [0, 1], [6, 1],
                [6, 2],
                [3, 3], [4, 3],
                [1, 4], [2, 4],
                [0, 5],
                [0, 6], [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "0": [
                [1, 0], [2, 0], [3, 0], [4, 0], [5, 0],
                [0, 1], [6, 1],
                [0, 2], [4, 2], [5, 2],
                [0, 3], [1, 3], [4, 3], [5, 3],
                [0, 4], [1, 4], [6, 4],
                [0, 5], [6, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "5": [
                [0, 0], [1, 0], [2, 0], [3, 0], [4, 0], [5, 0],
                [0, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2],
                [0, 3], [5, 3],
                [5, 4],
                [0, 5], [5, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ": [
                [3, 0], [5, 0],
                [3, 1], [4, 1], [6, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [5, 2],
                [3, 3],
                [1, 4], [3, 4], [5, 4],
                [0, 5], [3, 5], [6, 5],
                [2, 6], [3, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
            "ã‚¹": [
                [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [4, 3],
                [4, 4],
                [2, 5], [3, 5], [5, 5],
                [0, 6], [1, 6], [6, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ¼": [
                [0, 3], [1, 3], [2, 3], [3, 3], [4, 3], [5, 3], [6, 3]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ": [
                [2, 1], [4, 1],
                [2, 2], [5, 2],
                [2, 3], [5, 3],
                [1, 4], [6, 4],
                [1, 5], [6, 5],
                [0, 6], [6, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ¥": [
                [2, 3], [3, 3], [4, 3],
                [4, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ã‚·": [
                [1, 0], [6, 0],
                [2, 1], [6, 1],
                [1, 2], [6, 2],
                [2, 3], [6, 3],
                [5, 4],
                [4, 5],
                [1, 6], [2, 6], [3, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ–": [
                [3, 0], [5, 0],
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [5, 3],
                [4, 4],
                [3, 5],
                [1, 6], [2, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒ¤": [
                [2, 0],
                [2, 1], [4, 1], [5, 1], [6, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [6, 2],
                [2, 3], [5, 3],
                [3, 4],
                [3, 5],
                [3, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ã‚¨": [
                [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [3, 2],
                [3, 3],
                [3, 4],
                [0, 5], [1, 5], [2, 5], [3, 5], [4, 5], [5, 5], [6, 5]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ã‚³": [
                [0, 1], [1, 1], [2, 1], [3, 1], [4, 1], [5, 1],
                [5, 2],
                [5, 3],
                [5, 4],
                [5, 5],
                [0, 6], [1, 6], [2, 6], [3, 6], [4, 6], [5, 6]
            ].map(([x, y]) => [x * 30, y * 30]),
            "ãƒŠ": [
                [3, 0],
                [3, 1],
                [0, 2], [1, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2],
                [3, 3],
                [3, 4],
                [2, 5],
                [1, 6],
            ].map(([x, y]) => [x * 30, y * 30]),
        };

        // ========= å‡ºã™é †ç•ªï¼ˆå˜èªãƒªã‚¹ãƒˆï¼‰ =========
        let katakanaWords = [
            ["ãƒ•", "ã‚¸", "ã‚µ", "ã‚­", "ãƒŸ", "ã‚¯"],
            ["ã‚¿", "ãƒ³", "ã‚¸", "ãƒ§", "ã‚¦", "ãƒ“"],
            ["ã‚ª", "ãƒ¡", "ãƒ‡", "ãƒˆ", "ã‚¦"]
        ];

        let katakanaPatternIndex = 0; // ã©ã®å˜èªã‚’å‡ºã™ã‹ç®¡ç†

        function spawnKatakana(char, isLastChar = false) {
            const pattern = katakanaPatterns[char];
            const startX = canvas.width / 2 - 90; // ä¸­å¤®å¯„ã›

            // â˜… ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒˆã‚’ç½®ãä½ç½®ã‚’æ±ºã‚ã‚‹ï¼ˆãŸã ã— lives < 3 ã®å ´åˆã®ã¿ï¼‰
            let heartIndex = -1;
            if (isLastChar && lives < 3) {
                heartIndex = Math.floor(Math.random() * pattern.length);
            }

            pattern.forEach(([dx, dy], idx) => {
                let type = "star"; // åŸºæœ¬ã¯æ˜Ÿ
                if (idx === heartIndex) {
                    type = "heart";
                }
                items.push(new Item(type, startX + dx, dy - 100, 3));
            });
        }
        // ========= é›£æ˜“åº¦è¨­å®š =========
        const difficultySettings = {
            1: {
                minSpeed: 5,
                maxSpeed: 9,
                speedInterval: 20,
                dropIntervalBase: 400, // ğŸ‘ˆ åŸºæº–é–“éš”ï¼ˆmsï¼‰ã‚’è¿½åŠ 
                dropIntervalReduction: 100, // ğŸ‘ˆ æ¸›å°‘é‡ï¼ˆmsï¼‰ã‚’è¿½åŠ 
                bgFirst: "images/hint_bg.png",
                bgImages: ["images/bg01.png", "images/bg02.png", "images/bg03.png"],
                bgm: sounds.bgm_easy,
                defaultBg: "images/default_bg.png",
                katakanaWords: [
                    ["ãƒ•", "ã‚¸", "ã‚µ", "ã‚­", "ãƒŸ", "ã‚¯"],
                    ["ã‚»", "ã‚¤", "ã‚¿", "ãƒ³", "ã‚µ", "ã‚¤"],
                    ["2", "0", "2", "5"],
                    ["ãƒŸ", "ã‚¯", "ãƒ", "ãƒ£", "ãƒ³"],
                    ["ã‚ª", "ã‚¿", "ãƒ³", "ã‚¸", "ãƒ§", "ã‚¦", "ãƒ“"],
                    ["ã‚ª", "ãƒ¡", "ãƒ‡", "ãƒˆ", "ã‚¦"]
                ]
            },
            2: {
                minSpeed: 4,
                maxSpeed: 8,
                speedInterval: 20,
                dropIntervalBase: 600,
                dropIntervalReduction: 100,
                bgFirst: "images/hint_bg02.png",
                bgImages: ["images/bg04.png", "images/bg05.png", "images/bg06.png"],
                bgm: sounds.bgm_normal,
                defaultBg: "images/default_bg02.png",
                katakanaWords: [
                    ["ãƒŸ", "ã‚¯", "ãƒ", "ãƒ£", "ãƒ³"],
                    ["ã‚ª", "ã‚¿", "ãƒ³", "ã‚¸", "ãƒ§", "ã‚¦", "ãƒ“"],
                    ["ã‚ª", "ãƒ¡", "ãƒ‡", "ãƒˆ", "ã‚¦"],
                    ["ãƒ•", "ã‚¸", "ã‚µ", "ã‚­", "ãƒŸ", "ã‚¯"],
                    ["ã‚»", "ã‚¤", "ã‚¿", "ãƒ³", "ã‚µ", "ã‚¤"],
                    ["2", "0", "2", "5"],
                ]
            },
            3: {
                minSpeed: 3,
                maxSpeed: 7,
                speedInterval: 20,
                dropIntervalBase: 1000,
                dropIntervalReduction: 100,
                bgFirst: "images/hint_bg03.png",
                bgImages: ["images/bg07.png", "images/bg08.png", "images/bg08.png"],
                bgm: sounds.bgm_hard,
                defaultBg: "images/default_bg03.png",
                katakanaWords: [
                    ["ãƒ", "ã‚¹", "ã‚¿", "ãƒ¼", "ãƒ"],
                    ["ãƒˆ", "ã‚¦", "ã‚­", "ãƒ¥", "ã‚¦"],
                    ["ã‚·", "ãƒ–", "ãƒ¤", "ã‚¨", "ã‚­"],
                    ["ã‚³", "ã‚¦", "ãƒŠ", "ã‚¤"]
                ]
            }
        };

        // ========= ã‚¤ãƒ™ãƒ³ãƒˆé€²è¡Œ =========
        let eventTimers = []; // ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ç”¨
        let inKatakanaEvent = false; // â˜… ãƒ•ãƒ©ã‚°è¿½åŠ 
        let currentDifficulty = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        function scheduleEvents() {
            clearEventTimers(); // â† å¿µã®ãŸã‚æœ€åˆã§ã‚¯ãƒªã‚¢

            const runEvent = () => {
                eventPhase++;
                if (eventPhase % 3 === 1) {
                    // â‘  æ¨ªä¸€åˆ—
                    spawnPatternRow();
                    eventTimers.push(setTimeout(runEvent, 20000)); // 20ç§’å¾Œã«â‘¡
                }
                else if (eventPhase % 3 === 2) {
                    // â‘¡ 3å›é€£ç¶šï¼ˆ5ç§’ã”ã¨ï¼‰
                    let count = 0;
                    const int = setInterval(() => {
                        spawnPatternRow();
                        if (++count >= 3) {
                            clearInterval(int);
                            eventTimers.push(setTimeout(runEvent, 20000)); // 20ç§’å¾Œã«â‘¢
                        }
                    }, 5000);
                    eventTimers.push(int); // intervalã‚‚ç®¡ç†
                }
                else if (eventPhase % 3 === 0) {
                    // â‘¢ ã‚«ã‚¿ã‚«ãƒŠæ–‡å­—ï¼ˆé †ç•ªã«å˜èªã‚’ä½¿ç”¨ï¼‰
                    inKatakanaEvent = true; // â˜… é–‹å§‹æ™‚ã«ãƒ•ãƒ©ã‚°ON
                    katakanaIndex = 0;
                    const chars = katakanaWords[katakanaPatternIndex];

                    // â˜…èƒŒæ™¯ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ•ãƒªãƒƒãƒ—å¤‰æ›´
                    setBackgroundShuffledWithFlip();

                    const nextChar = () => {
                        if (!gameRunning) return;
                        if (katakanaIndex < chars.length) {
                            const isLastChar = (katakanaIndex === chars.length - 1);
                            spawnKatakana(chars[katakanaIndex], isLastChar); // â†è¿½åŠ 
                            katakanaIndex++;
                            const t = setTimeout(nextChar, 2000); // â˜… å¤‰æ•°ã«å…¥ã‚Œã‚‹
                            eventTimers.push(t);                  // â˜… ç®¡ç†ãƒªã‚¹ãƒˆã«è¿½åŠ 
                        } else {
                            // â˜… ã‚¤ãƒ™ãƒ³ãƒˆâ‘¢çµ‚äº† â†’ ãƒ•ãƒ©ã‚°OFF
                            inKatakanaEvent = false;

                            const resetT = setTimeout(() => {
                                resetBackgroundWithFlip();

                                minSpeed += 1;
                                speedLevel = minSpeed;
                                adjustDropRate(true);

                                gameStartTime = Date.now();
                            }, 2000);
                            eventTimers.push(resetT);

                            const t = setTimeout(runEvent, 10000); // â˜… å¤‰æ•°ã«å…¥ã‚Œã‚‹
                            eventTimers.push(t);                   // â˜… ç®¡ç†ãƒªã‚¹ãƒˆã«è¿½åŠ 
                            katakanaPatternIndex = (katakanaPatternIndex + 1) % katakanaWords.length;
                        }
                    };
                    nextChar();
                }
            };

            // åˆå›ã¯20ç§’å¾…ã£ã¦ã‹ã‚‰â‘ ã‚’ç™ºç”Ÿ
            eventTimers.push(setTimeout(runEvent, 20000));
        }



        // ========= ã‚²ãƒ¼ãƒ é€²è¡Œ =========
        let gameStartTime = Date.now();
        let speedLevel = 3;  // åˆæœŸã‚¹ãƒ”ãƒ¼ãƒ‰
        let minSpeed = 3;     // åˆæœŸå€¤
        let maxSpeed = 7;     // ä¸Šé™ã‚¹ãƒ”ãƒ¼ãƒ‰
        let speedInterval = 20; // ä¸Šæ˜‡é–“éš”ï¼ˆç§’ï¼‰

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            player.update();

            difficultyDisplay.textContent = "Level: " + currentDifficulty;

            // çµŒéæ™‚é–“ã§ã‚¹ãƒ”ãƒ¼ãƒ‰èª¿æ•´
            const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
            let newSpeed = minSpeed + Math.floor(elapsed / speedInterval);

            if (newSpeed !== speedLevel) {
                speedLevel = newSpeed;
                adjustDropRate(); // å‡ºç¾é–“éš”ã‚‚èª¿æ•´
            }

            items.forEach((item, i) => {
                item.speed = speedLevel * (downPressed ? 2 : 1);  // â˜… ä¸‹ã‚­ãƒ¼ã§å€é€Ÿ
                item.update();
                if (collision(player, item)) {
                    if (item.type === "candy") {
                        score += 3;
                        playSound(sounds.item);
                    } else if (item.type === "donut") {
                        score += 9;
                        playSound(sounds.item);
                    } else if (item.type === "star") {
                        score += 50000000;
                        playSound(sounds.item);
                    } else if (item.type === "heart") {
                        if (lives < 3) { // â˜… æœ€å¤§å€¤ä»¥ä¸Šã¯å¢—ãˆãªã„
                            lives++;
                            updateHearts();
                        }
                        playSound(sounds.heart);
                        items.splice(i, 1);
                    } else {
                        lives--;
                        updateHearts();
                        playSound(sounds.damage);
                        if (lives <= 0) endGame("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼");
                    }
                    items.splice(i, 1);
                } else if (item.y > canvas.height) {
                    items.splice(i, 1);
                }
            });

            // ã‚¹ã‚³ã‚¢æ›´æ–°
            document.getElementById("score").textContent = "Score: " + score;

            // â˜… ã‚¯ãƒªã‚¢åˆ¤å®š
            if (score >= 10000000000) {
                endGame("ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼");
            }
        }

        function collision(a, b) {
            return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
        }

        function clearEventTimers() {
            eventTimers.forEach(t => {
                clearTimeout(t);
                clearInterval(t);
            });
            eventTimers = [];
        }

        // ========= ã‚²ãƒ¼ãƒ é–‹å§‹/çµ‚äº† =========
        function initGame() {
            player = new Player(); items = []; score = 0; lives = 3; speedMultiplier = 1;
            eventPhase = 0; katakanaIndex = 0;
            katakanaPatternIndex = 0; // â† ã“ã‚Œã‚‚å¿˜ã‚Œãš
            inKatakanaEvent = false;  // â† å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
            clearEventTimers();       // â† ã‚¿ã‚¤ãƒãƒ¼å®Œå…¨æ¶ˆå»

            document.getElementById("score").textContent = "Score: 0";
            updateHearts();

            // ä¸¡æ–¹ã®ç”»é¢ã‚’æ¶ˆã™
            document.getElementById("gameOverScreen").style.display = "none";
            document.getElementById("clearScreen").style.display = "none";
        }

        let currentBgm = null;

        function startGame() {
            document.getElementById("startScreen").style.display = "none";
            document.getElementById("gameOverScreen").style.display = "none";
            document.getElementById("clearScreen").style.display = "none";
            document.getElementById("difficultyModal").style.display = "none";
            if (/iPad|iPhone|Android/i.test(navigator.userAgent)) {
                document.getElementById("controls").style.display = "flex";
            }
            // ğŸ¯ å…ˆã«é›£æ˜“åº¦è¨­å®šã‚’åæ˜ 
            const setting = difficultySettings[currentDifficulty];
            minSpeed = setting.minSpeed;
            speedLevel = setting.minSpeed;
            maxSpeed = setting.maxSpeed;
            bgImages = setting.bgImages;
            sounds.bgm = setting.bgm;
            katakanaWords = setting.katakanaWords;

            // ğŸ¯ ã“ã“ã‚’è¿½åŠ 
            defaultBgPath = setting.defaultBg;
            bgLayer.style.backgroundImage = `url(${defaultBgPath})`;
            shuffledImages = shuffleArray(bgImages); // æ–°ã—ã„é›£æ˜“åº¦ã®ç”»åƒã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            firstBgUsed = false; // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

            // ğŸ¯ é›£æ˜“åº¦ãŒåæ˜ ã•ã‚ŒãŸçŠ¶æ…‹ã§åˆæœŸåŒ–
            initGame();
            gameRunning = true;
            gameStartTime = Date.now();

            gameInterval = setInterval(gameLoop, 30);
            adjustDropRate(); // æœ€åˆã®å‡ºç¾é–“éš”ã‚’ã‚»ãƒƒãƒˆ

            clearEventTimers();   // â† å‰å›ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’å¿…ãšå‰Šé™¤
            scheduleEvents();
            // BGMåˆ‡æ›¿
            if (currentBgm) {
                currentBgm.pause(); // æ—¢å­˜ã®BGMã‚’åœæ­¢
            }
            currentBgm = setting.bgm; // æ–°ã—ã„BGMã‚’ã‚»ãƒƒãƒˆ

            if (currentBgm) {
            // BGMã®ãƒ«ãƒ¼ãƒ—ã¨éŸ³é‡ã‚’è¨­å®š
            currentBgm.loop = true;
            currentBgm.volume = 0.1; // éŸ³é‡èª¿æ•´ï¼ˆ0.0ã€œ1.0ï¼‰

            currentBgm.currentTime = 0;
            currentBgm.play();
            }
        }

        function endGame(status = "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼") {
            gameRunning = false;
            clearInterval(gameInterval);
            clearInterval(dropInterval);
            clearEventTimers();

            // â˜… ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒãƒ¼ã‚’å…¨åœæ­¢
            eventTimers.forEach(t => clearTimeout(t));
            eventTimers = [];

            document.getElementById("controls").style.display = "none";

            // BGMåœæ­¢
            if (currentBgm) {
                currentBgm.pause();
            }

            // åŠ¹æœéŸ³
            if (status === "ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼") {
                playSound(sounds.clear);
                document.getElementById("clearTitle").textContent = status;
                document.getElementById("finalClearScore").textContent = "Score: " + score;
                document.getElementById("clearScreen").style.display = "flex";
            } else {
                playSound(sounds.gameover);
                document.getElementById("endTitle").textContent = status;
                document.getElementById("finalScore").textContent = "Score: " + score;
                document.getElementById("gameOverScreen").style.display = "flex";
            }

            // â˜… Xå…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            const gameUrl = encodeURIComponent("https://roughlaughfan.github.io/mygame/");
            const scoreMessage = `ç‰¡è £ã‚µãƒ¼ãƒ¢ãƒ³ã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ ã§ã‚¹ã‚³ã‚¢${score}ç‚¹ã‚’é”æˆã—ã¾ã—ãŸï¼`;
            const hashtags = ["ç‰¡è £ã‚µãƒ¼ãƒ¢ãƒ³ã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ ", "è—¤å´å›£æ´»å‹•å ±å‘Š", "è—¤å´æœªæ¥ç”Ÿèª•ç¥­2025"];

            const formattedHashtags = hashtags.map(tag => `#${tag}`).join(" ");

            const shareText = encodeURIComponent(scoreMessage + "\n" + formattedHashtags);
            const shareUrl = `https://twitter.com/intent/tweet?text=${shareText}&url=${gameUrl}`;

            // â˜… ãƒœã‚¿ãƒ³ã«ãƒªãƒ³ã‚¯ã‚’è¨­å®š
            document.getElementById("shareBtn").onclick = () => {
                window.open(shareUrl, "_blank");
            };
            document.getElementById("shareBtn_top").onclick = () => {
                window.open(shareUrl, "_blank");
            };

        }

        // ========= ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾é–“éš”èª¿æ•´ =========
        function adjustDropRate(reset = false) {
            clearInterval(dropInterval);
            const setting = difficultySettings[currentDifficulty]; // ğŸ‘ˆ é›£æ˜“åº¦è¨­å®šã‚’å–å¾—

            if (reset) {
                // åˆæœŸã®å‡ºç¾é–“éš”ã«æˆ»ã™ï¼ˆä¾‹: 1000msï¼‰
                dropInterval = setInterval(spawnItem, setting.dropIntervalBase); // ğŸ‘ˆ é›£æ˜“åº¦ã”ã¨ã®åŸºæº–é–“éš”ã‚’ä½¿ç”¨
            } else {
                // ğŸ¯ æ–°ã—ã„è¨ˆç®—å¼
                const interval = Math.max(300, setting.dropIntervalBase / speedLevel);
                dropInterval = setInterval(spawnItem, interval);

            }
        }

        // ========= æ“ä½œ =========
        let leftPressed = false;
        let rightPressed = false;
        let downPressed = false;

        document.addEventListener("keydown", e => {
            if (!gameRunning) return;

            if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") leftPressed = true;
            if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") rightPressed = true;
            if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") downPressed = true;
            if (e.key === " " || e.key === "ArrowUp" || e.key.toLowerCase() === "w") player.jump();
        });

        document.addEventListener("keyup", e => {
            if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") leftPressed = false;
            if (e.key === "ArrowRight" || e.key.toLowerCase() === "d") rightPressed = false;
            if (e.key === "ArrowDown" || e.key.toLowerCase() === "s") downPressed = false;
        });


        // ========= ã‚¹ãƒãƒ›æ“ä½œï¼ˆãƒãƒ«ãƒã‚¿ãƒƒãƒå¯¾å¿œï¼‰ =========
        let activeTouches = {
            left: null,
            right: null
        };

        document.getElementById("leftBtn").addEventListener("touchstart", e => {
            e.preventDefault();
            if (!gameRunning) return;
            if (activeTouches.left === null) {
                activeTouches.left = e.changedTouches[0].identifier;
                leftPressed = true;
            }
        });

        document.getElementById("leftBtn").addEventListener("touchend", e => {
            [...e.changedTouches].forEach(touch => {
                if (touch.identifier === activeTouches.left) {
                    leftPressed = false;
                    activeTouches.left = null;
                }
            });
        });

        document.getElementById("rightBtn").addEventListener("touchstart", e => {
            e.preventDefault();
            if (!gameRunning) return;
            if (activeTouches.right === null) {
                activeTouches.right = e.changedTouches[0].identifier;
                rightPressed = true;
            }
        });

        document.getElementById("rightBtn").addEventListener("touchend", e => {
            [...e.changedTouches].forEach(touch => {
                if (touch.identifier === activeTouches.right) {
                    rightPressed = false;
                    activeTouches.right = null;
                }
            });
        });

        // ã‚¸ãƒ£ãƒ³ãƒ—ã¯å˜ç™ºãªã®ã§å˜ç´”ã§OK
        document.getElementById("jumpBtn").addEventListener("touchstart", e => {
            e.preventDefault();
            if (gameRunning) player.jump();
        });

        // ========= ãƒœã‚¿ãƒ³ =========
        const startBtn = document.getElementById("startBtn");
        const startBtnText = document.getElementById("startBtnText");
        const difficultyModal = document.getElementById("difficultyModal");
        let isModalOpen = false;

        // ã€ŒéŠã¶ã€/ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
        startBtn.addEventListener("click", () => {
            if (isModalOpen) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆ â†’ é–‰ã˜ã‚‹
                difficultyModal.style.display = "none";
                startBtnText.textContent = "éŠã¶";
                isModalOpen = false;
            } else {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆ â†’ é–‹ã
                difficultyModal.style.display = "block";
                startBtnText.textContent = "é–‰ã˜ã‚‹";
                isModalOpen = true;
            }
        });

        // é›£æ˜“åº¦ãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
        document.querySelectorAll(".diffBtn").forEach(btn => {
            btn.addEventListener("click", e => {
                currentDifficulty = parseInt(e.target.dataset.level);
                difficultyModal.style.display = "none";
                startBtnText.textContent = "éŠã¶"; // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’ã€ŒéŠã¶ã€ã«æˆ»ã™
                isModalOpen = false;
                startGame();
            });
        });

        document.getElementById("retryBtn").onclick = startGame;
        document.getElementById("retryBtn_agein").onclick = startGame;
        document.getElementById("backToStartBtn").onclick = () => {
            document.getElementById("gameOverScreen").style.display = "none";
            document.getElementById("startScreen").style.display = "flex";
        };
        document.getElementById("backToStartBtn_top").onclick = () => {
            document.getElementById("clearScreen").style.display = "none";
            document.getElementById("startScreen").style.display = "flex";
        };

    </script>
</body>


</html>